# üîπ 1. –°—Ç–∞–¥–∏—è —Å–±–æ—Ä–∫–∏ (builder)
FROM golang:1.24-alpine AS builder

# –î–æ–±–∞–≤–ª—è–µ–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –¥–ª—è HTTPS (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è PostgreSQL)
RUN apk add --no-cache ca-certificates

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
WORKDIR /app

# –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Ö
COPY go.mod go.sum ./
RUN go mod download

# –ö–æ–ø–∏—Ä—É–µ–º –≤–µ—Å—å –∫–æ–¥ –ø—Ä–æ–µ–∫—Ç–∞
COPY . .

# –°–æ–±–∏—Ä–∞–µ–º –±–∏–Ω–∞—Ä–Ω–∏–∫
RUN go build -o /app/gateway cmd/service/main.go

# üîπ 2. –§–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (—á–∏—Å—Ç—ã–π –∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π)
FROM alpine:latest

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
WORKDIR /app

# –ö–æ–ø–∏—Ä—É–µ–º –±–∏–Ω–∞—Ä–Ω–∏–∫ –∏–∑ builder-—Å—Ç–∞–¥–∏–∏ (–±–µ–∑ –ª–∏—à–Ω–∏—Ö —Ñ–∞–π–ª–æ–≤)
COPY --from=builder /app/gateway /app/gateway

# –î–µ–ª–∞–µ–º –±–∏–Ω–∞—Ä–Ω–∏–∫ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
RUN chmod +x /app/gateway

# –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
CMD ["/app/gateway"]
